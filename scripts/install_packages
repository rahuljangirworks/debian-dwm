#!/bin/bash

# Exit on error
set -euo pipefail

GREEN="\033[1;32m"
RED="\033[1;31m"
YELLOW="\033[1;33m"
NC="\033[0m"

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

if command -v apt &> /dev/null; then
    # Attempt to install nala
    if ! command -v nala &> /dev/null; then
        echo -e "${YELLOW}Attempting to install nala...${NC}"
        if "$SCRIPT_DIR/install_nala"; then
            echo -e "${GREEN}Nala installed successfully.${NC}"
        else
            echo -e "${YELLOW}Failed to install nala. Falling back to apt.${NC}"
        fi
    fi

    echo -e "${YELLOW}Installing dependencies...${NC}"
    
    # Define a list of main packages (inline, additional to common_packages.txt)
    packages=(
        "sxhkd"
        "firefox-esr"
        "kitty"
        "alacritty"
        "flameshot"
        "ranger"
    )

    # Function to read and append common packages from a file
    read_common_packages() {
        local common_file="$1"
        if [[ -f "$common_file" ]]; then
            while IFS= read -r pkg || [[ -n "$pkg" ]]; do
                # Ignore empty lines and comments
                [[ -z "$pkg" || "$pkg" =~ ^# ]] && continue
                packages+=("$pkg")
            done < "$common_file"
        else
            echo -e "${RED}Common packages file not found: $common_file${NC}"
        fi
    }

    # Function to install packages if they are not already installed
    install_packages() {
        local pkgs=("$@")
        local missing_pkgs=()

        # Check if each package is installed
        for pkg in "${pkgs[@]}"; do
            if ! dpkg -l "$pkg" 2>/dev/null | grep -q "^ii"; then
                missing_pkgs+=("$pkg")
            fi
        done

        # Install missing packages
        if [[ ${#missing_pkgs[@]} -gt 0 ]]; then
            echo -e "${YELLOW}Installing missing packages: ${missing_pkgs[*]}${NC}"
            if command -v nala &> /dev/null; then
                sudo nala update
                sudo nala install -y "${missing_pkgs[@]}" || true
            else
                sudo apt update
                sudo apt install -y "${missing_pkgs[@]}" || true
            fi
        else
            echo -e "${GREEN}All required packages are already installed.${NC}"
        fi
    }

    # Read common packages from file (relative to this script)
    common_packages_file="$SCRIPT_DIR/common_packages.txt"
    read_common_packages "$common_packages_file"

    install_packages "${packages[@]}"

    # Enable services (only if they exist)
    echo -e "${YELLOW}Enabling services...${NC}"
    if systemctl list-unit-files | grep -q avahi-daemon; then
        sudo systemctl enable avahi-daemon
    fi
    if systemctl list-unit-files | grep -q acpid; then
        sudo systemctl enable acpid
    fi

    # Update user directories
    xdg-user-dirs-update || true
    mkdir -p ~/Screenshots/

    # Ensure /usr/share/xsessions directory exists
    if [[ ! -d /usr/share/xsessions ]]; then
        echo -e "${YELLOW}Creating /usr/share/xsessions...${NC}"
        sudo mkdir -p /usr/share/xsessions
    fi

    # Install picom
    if "$SCRIPT_DIR/picom"; then
        echo -e "${GREEN}Picom setup completed.${NC}"
    else
        echo -e "${RED}Picom installation failed.${NC}"
    fi

else
    echo -e "${YELLOW}APT not found. Launching linutil for package management...${NC}"
    curl -fsSL https://christitus.com/linux | sh
fi